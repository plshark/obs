<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>æ“ä½œç”»é¢</title>
</head>

<style>
  button {
    height: 100px;
    width: 200px;
    font-size: 20px;
    border-radius: 5px;
    margin: 0 5px;
  }

  input {
    height: 100px;
    width: 200px;
    font-size: 24px;
    border-radius: 5px;
    margin: 0 5px;

  }

  .row {
    margin-top: 10px;
  }

  .container {
    display: grid;
    grid-template-columns: auto auto auto auto;
    gap: 5px;
  }

  .button {
    border: 1px solid #000000;
    border-radius: 5px;
    padding: 5px;
    cursor: pointer;
    height: 100px;
    text-align: center;
    line-height: 100px;
    font-size: 24px;
  }
  .button-wide {
    grid-column-start: 1;
    grid-column-end: 3;
  }

  .button-wide-2 {
    grid-column-start: 3;
    grid-column-end: 5;
  }
</style>

<body>
  <h1>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«</h1>
  <div class="container">
    <div class="button" onclick="showOnly('camera_source')">ã‚«ãƒ¡ãƒ©</div>
    <div class="button" onclick="showOnly('slide_source')">ã‚¹ãƒ©ã‚¤ãƒ‰</div>
    <div class="button" onclick="toggleBlackout()">ğŸŒ‘ æš—è»¢ãƒˆã‚°ãƒ«</div>
    <div class="button button-wide" onclick="prevName()">â—€ å‰ã¸</div>
    <div class="button button-wide-2" onclick="nextName()">æ¬¡ã¸ â–¶</div>
  </div>
  <div class="row">
    <button onclick="showSpecialMessage('æº–å‚™ä¸­ã§ã™')">æº–å‚™ä¸­ã§ã™</button>
  </div>
  <div class="row">
    <input type="text" id="customTextInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
    <button onclick="sendCustomMessage()">è¡¨ç¤º</button>
  </div>

  <ul id="nameList"></ul>

  <script>
    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
    // â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•
    // â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• 
    // â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  
    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    // â•šâ•â•â•â•â•â• â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   

    const ws = new WebSocket('ws://127.0.0.1:8090');
    ws.onopen = () => {
      console.log('âœ… WebSocketæ¥ç¶šæˆåŠŸ');
    };

    ws.onerror = (err) => {
      console.error('ğŸ›‘ WebSocketã‚¨ãƒ©ãƒ¼:', err);
    };

    ws.onclose = () => {
      console.log('âŒ WebSocketåˆ‡æ–­');
    };

    function sendCurrentName() {
      if (names[currentIndex]) {
        const msg = { type: 'name', text: names[currentIndex] };
        console.log('ğŸ“¤ é€ä¿¡:', msg);
        ws.send(JSON.stringify(msg));
      }
    }


    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
    // â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
    // â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
    // â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
    // â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•

    const nameList = document.getElementById('nameList');
    let names = [];
    let currentIndex = 0;
    let isShowingSpecial = false;

    fetch('names.csv')
      .then(res => res.text())
      .then(csvText => {
        const lines = csvText.trim().split('\n');
        names = lines.map(line => {
          // å„è¡Œã‚’ã‚«ãƒ³ãƒã§åˆ†å‰²ã—ã€ä½™åˆ†ãª " ã‚’å–ã‚Šé™¤ã„ã¦ã‚¹ãƒšãƒ¼ã‚¹ã§çµåˆ
          return line.split(',').map(s => s.trim().replace(/^"|"$/g, '')).join('        ');
        });
        console.log(names)
        renderList();
      });

    function renderList() {
      nameList.innerHTML = '';
      names.forEach((name, i) => {
        const li = document.createElement('li');
        li.textContent = `${i === currentIndex ? 'â–¶ ' : ''}${name}`;
        nameList.appendChild(li);
      });
    }

    function sendCurrentName() {
      if (names[currentIndex]) {
        ws.send(JSON.stringify({ type: 'name', text: names[currentIndex] }));
      }
    }

    async function nextName() {
      // await showOnly('slide_source')
      if (isShowingSpecial) {
        isShowingSpecial = false;
        sendCurrentName(); // ç¾åœ¨ã®åå‰ã«æˆ»ã™
        renderList();
        return;
      }

      currentIndex = (currentIndex + 1) % names.length;
      sendCurrentName();
      renderList();
      currentSource = ''
    }

    async function prevName() {
      // await showOnly('slide_source')
      if (isShowingSpecial) {
        isShowingSpecial = false;
        sendCurrentName();
        renderList();
        return;
      }

      currentIndex = (currentIndex - 1 + names.length) % names.length;
      sendCurrentName();
      renderList();
    }


    // â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
    // â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
    // â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â•    â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• 
    // â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     
    // â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•     

    document.addEventListener('keydown', async (e) => {
      const tag = document.activeElement.tagName;

      if (tag === 'INPUT' || tag === 'TEXTAREA') return;

      if (e.key === 'a') {
        if (currentSource === 'camera_source') {
          await showOnly('slide_source')
          currentSource = 'slide_source'
        }
        prevName(); // â—€ å‰ã®åå‰
      }

      if (e.key === 'd') {
        if (currentSource === 'camera_source') {
          await showOnly('slide_source') // å¼·åˆ¶çš„ã«ã‚¹ãƒ©ã‚¤ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
          currentSource = 'slide_source'
        }
        nextName(); // â–¶ æ¬¡ã®åå‰
      }
      if (e.code === 'Space') {
        e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        toggleCameraSlide();
      }
      if (e.key === 'w') {
        await toggleBlackout();
      }
    });


    //  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    // â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•
    // â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    // â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â•â•â–ˆâ–ˆâ•‘
    // â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
    //  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•

    let obs;

    async function connectOBS() {
      const { default: OBSWebSocket } = await import('https://cdn.jsdelivr.net/npm/obs-websocket-js/+esm');
      obs = new OBSWebSocket();
      try {
        await obs.connect('ws://localhost:4455'); // ãƒãƒ¼ãƒˆç•ªå·ã¯ç’°å¢ƒã«åˆã‚ã›ã¦
        await getSceneItemIds();
        console.log('OBSã«æ¥ç¶šã—ã¾ã—ãŸ');
      } catch (err) {
        console.error('OBSæ¥ç¶šå¤±æ•—:', err);
      }
    }

    connectOBS();

    let currentSource = 'camera_source'; // åˆæœŸçŠ¶æ…‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰

    async function toggleCameraSlide() {
      clearBlackout()
      currentSource = currentSource === 'camera_source' ? 'slide_source' : 'camera_source';
      await showOnly(currentSource);
    }


    async function showOnly(sourceNameToEnable) {
      clearBlackout()
      const sources = ['camera_source', 'slide_source'];
      const res = await obs.call('GetSceneItemList', { sceneName: 'main_scene' });

      for (const srcName of sources) {
        const item = res.sceneItems.find(item => item.sourceName === srcName);
        if (item) {
          await obs.call('SetSceneItemEnabled', {
            sceneName: 'main_scene',
            sceneItemId: item.sceneItemId,
            sceneItemEnabled: srcName === sourceNameToEnable
          });
        }
      }
      currentSource = sourceNameToEnable
    }


    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    // â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    // â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
    // â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   
    // â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•    â•šâ•â•   

    let blackoutItemId;
    async function getSceneItemIds() {
      const res = await obs.call('GetSceneItemList', { sceneName: 'main_scene' });
      for (const item of res.sceneItems) {
        if (item.sourceName === 'blackout_source') {
          blackoutItemId = item.sceneItemId;
        }
      }
    }
    let isBlackout = false;

    async function toggleBlackout() {
      isBlackout = !isBlackout;

      if (!blackoutItemId) return;

      await obs.call('SetSceneItemEnabled', {
        sceneName: 'main_scene',
        sceneItemId: blackoutItemId,
        sceneItemEnabled: isBlackout,
      });

      console.log(isBlackout ? 'ğŸŒ‘ æš—è»¢ ON' : 'â˜€ï¸ æš—è»¢ OFF');
    }

    async function clearBlackout() {
      isBlackout = false
      console.log(blackoutItemId)
      if (!blackoutItemId) return;
      await obs.call('SetSceneItemEnabled', {
        sceneName: 'main_scene',
        sceneItemId: blackoutItemId,
        sceneItemEnabled: false,
      });
    }

    // special
    function showSpecialMessage(message) {
      ws.send(JSON.stringify({ type: 'special', text: message }));
    }

    function sendCustomMessage() {
      const input = document.getElementById('customTextInput');
      const text = input.value.trim();
      if (text) {
        ws.send(JSON.stringify({ type: 'special', text }));
        console.log('ğŸ“¤ ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:', text);
        input.value = ''; // é€ä¿¡å¾Œã‚¯ãƒªã‚¢
      }
    }

  </script>
</body>

</html>