<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>æ“ä½œç”»é¢</title>
</head>

<body>
  <h1>å‚åŠ è€…è¡¨ç¤ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h1>
  <button onclick="switchScene('ã‚«ãƒ¡ãƒ©')">ğŸ¥ ã‚«ãƒ¡ãƒ©</button>
  <button onclick="switchScene('ã‚¹ãƒ©ã‚¤ãƒ‰')">ğŸ–¥ ã‚¹ãƒ©ã‚¤ãƒ‰</button>

  <button onclick="switchToCamera()">ã‚«ãƒ¡ãƒ©</button>
  <button onclick="switchToSlide()">ã‚¹ãƒ©ã‚¤ãƒ‰</button>

  <button onclick="hideText()">â›” æš—è»¢</button>

  <button onclick="prevName()">â—€ å‰ã¸</button>
  <button onclick="nextName()">æ¬¡ã¸ â–¶</button>
  <ul id="nameList"></ul>

  <script>
    const ws = new WebSocket('ws://127.0.0.1:8090');
    const nameList = document.getElementById('nameList');
    let names = [];
    let currentIndex = 0;

    fetch('names.json')
      .then(res => res.json())
      .then(data => {
        names = data;
        renderList();
      });

    function renderList() {
      nameList.innerHTML = '';
      names.forEach((name, i) => {
        const li = document.createElement('li');
        li.textContent = `${i === currentIndex ? 'â–¶ ' : ''}${name}`;
        nameList.appendChild(li);
      });
    }

    function sendCurrentName() {
      if (names[currentIndex]) {
        ws.send(JSON.stringify({ type: 'name', text: names[currentIndex] }));
      }
    }

    function hideText() {
      ws.send(JSON.stringify({ type: 'hide' }));
    }

    function nextName() {
      currentIndex = (currentIndex + 1) % names.length;
      sendCurrentName();
      renderList();
    }

    function prevName() {
      currentIndex = (currentIndex - 1 + names.length) % names.length;
      sendCurrentName();
      renderList();
    }
    ws.onopen = () => {
      console.log('âœ… WebSocketæ¥ç¶šæˆåŠŸ');
    };

    ws.onerror = (err) => {
      console.error('ğŸ›‘ WebSocketã‚¨ãƒ©ãƒ¼:', err);
    };

    ws.onclose = () => {
      console.log('âŒ WebSocketåˆ‡æ–­');
    };

    function sendCurrentName() {
      if (names[currentIndex]) {
        const msg = { type: 'name', text: names[currentIndex] };
        console.log('ğŸ“¤ é€ä¿¡:', msg);
        ws.send(JSON.stringify(msg));
      }
    }

    //keymap
    document.addEventListener('keydown', (e) => {
      if (e.key === 'a') {
        prevName(); // â—€ å‰ã®åå‰
      }
      if (e.key === 'd') {
        nextName(); // â–¶ æ¬¡ã®åå‰
      }
    });

    let obs;

    async function connectOBS() {
      const { default: OBSWebSocket } = await import('https://cdn.jsdelivr.net/npm/obs-websocket-js/+esm');
      obs = new OBSWebSocket();
      try {
        await obs.connect('ws://localhost:4455'); // ãƒãƒ¼ãƒˆç•ªå·ã¯ç’°å¢ƒã«åˆã‚ã›ã¦
        console.log('OBSã«æ¥ç¶šã—ã¾ã—ãŸ');
      } catch (err) {
        console.error('OBSæ¥ç¶šå¤±æ•—:', err);
      }
    }

    connectOBS();

    let currentSource = 'camera_source'; // åˆæœŸçŠ¶æ…‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰

    async function toggleCameraSlide() {
      currentSource = currentSource === 'camera_source' ? 'slide_source' : 'camera_source';
      await showOnly(currentSource);
    }

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        toggleCameraSlide();
      }
    });

    async function showOnly(sourceNameToEnable) {
      const sources = ['camera_source', 'slide_source'];
      const res = await obs.call('GetSceneItemList', { sceneName: 'main_scene' });

      for (const srcName of sources) {
        const item = res.sceneItems.find(item => item.sourceName === srcName);
        if (item) {
          await obs.call('SetSceneItemEnabled', {
            sceneName: 'main_scene',
            sceneItemId: item.sceneItemId,
            sceneItemEnabled: srcName === sourceNameToEnable
          });
        }
      }
    }


  </script>
</body>

</html>