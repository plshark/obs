<html lang="ja">

<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0;
      background: rgba(0, 0, 0, 0);
      font-size: 512px;
      color: #00ffff;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }

    #text {
      position: absolute;
      top: 50%;
      left: 100%;
      white-space: nowrap;
      animation: scroll-left linear infinite;
      animation-fill-mode: forwards;
      opacity: 0;
      /* ← 追加 */
      transition: opacity 0.3s ease;
      transform-origin: center;
    }

    @keyframes scroll-left {
      from {
        transform: translateX(0%) translateY(-50%) scaleX(0.5);
      }

      to {
        transform: translateX(var(--scroll-end)) translateY(-50%) scaleX(0.5);
      }
    }
  </style>

</head>

<body>
  <div id="text"></div>

  <script>
    const textElem = document.getElementById('text');
    let isShowingSpecial = false;
    let currentText = "";

    let ws;
    let retryTimeout = 1000; // 初回は1秒待つ

    function connectWebSocket() {
      ws = new WebSocket('ws://localhost:8090');

      ws.onopen = () => {
        console.log('✅ WebSocket connected');
        retryTimeout = 1000; // 成功したらリトライ間隔リセット
      };

      ws.onmessage = async (event) => {
        const text = await event.data.text();
        const data = JSON.parse(text);

        if (data.type === 'name') {
          isShowingSpecial = false; // 特別メッセージ解除
          currentText = data.text;
          playLoop();
        }

        if (data.type === 'special') {
          isShowingSpecial = true; // 特別モードに切り替え
          currentText = data.text;
          playLoop();
        }



        if (data.type === 'hide') {
          fadeOutText();
        }
      };

      function fadeOutText() {
        textElem.style.animation = 'none';
        textElem.style.transition = 'opacity 1s';
        textElem.style.opacity = '0';
      }

      ws.onclose = () => {
        console.warn('⚠️ WebSocket closed, retrying in', retryTimeout, 'ms');
        setTimeout(connectWebSocket, retryTimeout);
        retryTimeout = Math.min(retryTimeout * 2, 10000); // 最大10秒まで増加
      };

      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        ws.close();
      };
    }

    function playLoop() {
      if (!currentText) return;

      textElem.style.transition = 'none';

      textElem.innerText = currentText;

      textElem.style.opacity = '1';

      textElem.style.animation = 'none';
      void textElem.offsetWidth;

      const textWidth = textElem.offsetWidth;
      const screenWidth = window.innerWidth;
      const totalDistance = textWidth + screenWidth;

      // 小さくするほど遅くなる
      const duration = totalDistance / 500;

      textElem.style.setProperty('--scroll-end', `-${totalDistance}px`);
      textElem.style.animation = `scroll-left ${duration}s linear forwards`;
    }

    textElem.addEventListener('animationend', playLoop);
    connectWebSocket();
  </script>
</body>

</html>